---
- name: Remove old host key locally
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Get current known hosts
      shell: cat ~/.ssh/known_hosts
      register: known_hosts
      changed_when: false
      failed_when: false

    - name: Remove matching host key
      shell: ssh-keygen -R "{{ hostvars['rop01']['ansible_host'] }}"
      register: remove_result
      changed_when: remove_result.rc == 0
      failed_when: false
      when: hostvars['rop01']['ansible_host'] in known_hosts.stdout

    - name: Accept new host key
      shell: ssh-keyscan -H "{{ hostvars['rop01']['ansible_host'] }}" >> ~/.ssh/known_hosts
      register: keyscan_result
      changed_when: keyscan_result.rc == 0
      failed_when: false

    - name: Display host key management results
      debug:
        msg: 
          - "Host key removal: {{ remove_result }}"
          - "Host key acceptance: {{ keyscan_result }}"

- name: Setup SSH Keys
  hosts: rop01
  become: true
  vars:
    ssh_public_key: "{{ lookup('file', '~/.ssh/rop01_key.pub') }}"
  tasks:
    - name: Create rop01_user user if not exists
      user:
        name: rop01_user
        shell: /bin/bash
        create_home: yes
        state: present

    - name: Create .ssh directory
      file:
        path: /home/rop01_user/.ssh
        state: directory
        mode: '0700'
        owner: rop01_user
        group: rop01_user

    - name: Add SSH public key
      authorized_key:
        user: rop01_user
        state: present
        key: "{{ ssh_public_key }}"
        key_options: 'no-port-forwarding,no-agent-forwarding,no-X11-forwarding'

    - name: Set up sudo access for rop01_user
      lineinfile:
        path: /etc/sudoers.d/rop01_user
        line: "rop01_user ALL=(ALL) NOPASSWD: ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'

    - name: Display SSH setup complete message
      debug:
        msg: "SSH key setup complete. You can now SSH as rop01_user user using the rop01_key" 